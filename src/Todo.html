<style>
input[type=checkbox].bigbox {
    width: 50px;
    height: 50px;
}
.bigbutton {
    height: 64px;
    padding:0;
    border:0
}
</style>

<div class="card">
    <div class="card-header">
        <h5>
            {category}
            {#if $sumByCategory[category]}
            <small> ( {formatPrice($sumByCategory[category] )} ) </small>
            {/if}
            <button type="button" class="close" title="Close" on:click="fire('close', {name})">
                <span aria-hidden="true">&times;</span>
            </button>
        </h5>
        <div class="progress" style="height: 30px">
            <div class="progress-bar"
                role="progressbar"
                style="width: {($progress[category].done / $progress[category].all) * 100 }%;"
                aria-valuenow={($progress[category].done / $progress[category].all) * 100}
                aria-valuemin="0"
                aria-valuemax="100">{Math.floor(($progress[category].done / $progress[category].all) * 100)}%</div>
        </div>
    </div>

    <div class="card-body">
            <div class="row mb-4">
                {#each $items as {name, price, category: itemCat}, idx}
                {#if category === itemCat}
                <div class="input-group mb-1">

                    <div class="input-group-prepend">
                        <button
                            class="btn btn-dark dropdown-toggle"
                            type="button"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"
                            on:click="toggleItemMenu(idx)"></button>

                        <div class="dropdown-menu {showMenu(idx)}">
                            <button class="dropdown-item"> remember </button>
                            <div role="separator" class="dropdown-divider"></div>
                            <button class="dropdown-item" on:click="deleteItem(idx)"> delete </button>
                        </div>

                    </div>

                    <div class=" form-control bigbutton">
                        <button class=" btn btn-outline-success list-group-item-action d-flex align-items-center" on:click="checkItem(idx)">
                            <input
                                type="checkbox"
                                class="bigbox"
                                bind:group=checked
                                value={idx}
                                disabled
                                aria-label="Checkbox for following text input"/>
                            {name}
                            {#if price}
                            ({formatPrice(price)})
                            {/if}
                        </button>
                    </div>


                </div>
                {/if}
                {/each}
            </div>

            <div class="row">

                <div class="input-group">

                    <input type="text" class="form-control" aria-label="item"
                    style="display: {showCustomMenu ? 'block' : 'none'};" placeholder="new item"
                    bind:value=customItemName
                    />

                    <input type="text" class="form-control" aria-label="price"
                    style="display: {showCustomMenu && showAddPrice ? 'block' : 'none'};" placeholder="price"
                    bind:value=customItemPrice
                    />
                    <button type="button" class="btn btn-success" style="display: {!showCustomMenu ? 'block' : 'none'};" on:click="fire('showCatalogue')">add</button>

                    <div class="input-group-append" tansition:slide>
                        <button type="button" class="btn btn-outline-warning" style="display: {showCustomMenu && !showAddPrice  ? 'block' : 'none'};" on:click="toggleShowAddPrice()">€</button>
                        <button type="button" class="btn btn-primary" style="display: {showCustomMenu? 'block' : 'none'};" on:click="addCustomItem()">add</button>

                        <button type="button" class="btn btn-outline-secondary" on:click="toggleAddMenu()">{showCustomMenu ? '-' : '+'}</button>
                    </div>

                </div>

            </div>

    </div>
</div>

<script>
export default {
    oncreate() {
        const {items}  = this.store.get();

        const checked = items.map(({done}, idx) => ({done, idx}) )
            .filter(({done}) => done)
            .map(({idx}) => idx)
        this.set({checked});

    },

    onupdate() {
        const state = this.get();
        console.dir({state});
    },

    data: () => ({
        items: [],
        checked: [],
        itemMenu: -1,
        showCustomMenu: false,
        showAddPrice: false,
        customItemName: null,
        customItemPrice: null,
    }),

    helpers: {
        formatPrice: (price /*: number*/)/*: string*/ =>
            (typeof price === 'number') && price.toFixed(2).toString().replace('.', ',') + `€`
    },

    computed: {
        showMenu: ({itemMenu}) => (idx) => itemMenu === idx ? 'show' : ''
    },
    methods: {
        checkItem(idx) {
            const {items} = this.store.get();

            items[idx].done = !items[idx].done;
            const checked = items.map(({ done }, idx) => ({ done, idx }))
                .filter(({ done }) => done)
                .map(({ idx }) => idx)
            this.set({ checked });
            this.store.set({ items: [...items] });
        },

        addCustomItem() {
            const {items} = this.store.get();
            const {customItemName, customItemPrice, category} = this.get();
            if (customItemName) {
                const item = {name: customItemName, price: Number.parseFloat(customItemPrice), category};
                this.store.set({ items: [...items, item] });
                this.set({
                    customItemName: null,
                    customItemPrice: null,
                    showAddPrice: false,
                    showCustomMenu: false,
                });
            }
        },

        toggleAddMenu() {
            const {showCustomMenu} = this.get();
            this.set({
                showCustomMenu: !showCustomMenu,
                showAddPrice: false
            });
        },

        toggleShowAddPrice() {
            const {showAddPrice} = this.get();
            this.set({showAddPrice: !showAddPrice});
        },

        toggleItemMenu(idx) {
            const {itemMenu} = this.get();
            if (itemMenu == idx) {
                this.set({itemMenu: -1 })
            } else {
                this.set({itemMenu: idx})
            }
        },

        deleteItem(idx) {
            const {items} = this.store.get();

            const newItems = [...items.filter((i, index) => index !== idx)];
            const checked = newItems.map(({done}, idx) => ({done, idx}) )
                .filter(({done}) => done)
                .map(({idx}) => idx)
            this.set({checked, itemMenu: -1});
            this.store.set({items: newItems})
        }
    },
}
</script>